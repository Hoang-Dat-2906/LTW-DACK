@model DACK.Models.Product

@{
    ViewData["Title"] = Model.ProductName;
}
<style>
    .detail-img-box {
        width: 120px;
        height: 120px;
        border: 1px solid #ddd;
        overflow: hidden;
        border-radius: 6px;
    }
    /* ===== PRODUCT DETAIL GALLERY ===== */

    .product-detail-gallery {
        display: flex;
        gap: 12px;
        flex-wrap: nowrap;
    }

    .detail-img-box {
        width: 100px;
        height: 100px;
        border: 1px solid #ddd;
        border-radius: 6px;
        overflow: hidden;
        cursor: pointer;
        background: #fff;
    }

        .detail-img-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .detail-img-box:hover {
            border-color: #000;
            transform: scale(1.05);
            transition: all 0.2s ease;
        }
    /* Tab Header Styling */
    .nav-tabs .nav-link {
        color: #111;
        font-weight: 600;
        text-transform: uppercase;
        border: none;
    }

        .nav-tabs .nav-link.active {
            color: #ca1515 !important;
            border-bottom: 2px solid #ca1515;
        }
    .related-products .product__item__text *,
    .related-products .product__item__text {
        position: static !important;
        top: auto !important;
        left: auto !important;
        right: auto !important;
        bottom: auto !important;
        transform: none !important;
    }

    /* Container text */
    .related-products .product__item__text {
        display: flex !important;
        flex-direction: column !important;
        gap: 10px;
        padding: 15px;
        text-align: center !important;
    }

    /* ADD TO CART */
    .related-products .add-cart {
        order: 1 !important;
        display: block !important;
        position: relative !important;
        opacity: 0;
        visibility: hidden;
        color: #ca1515 !important;
        font-weight: 700;
        transition: opacity 0.3s ease;
    }

    /* PRODUCT NAME */
    .related-products .product__item__text h6 {
        order: 2 !important;
        margin: 0 !important;
        line-height: 1.4;
        opacity: 1 !important;
        visibility: visible !important;
    }

    /* PRICE */
    .related-products .product__item__text h5 {
        order: 3 !important;
        margin: 0 !important;
    }

    /* HOVER */
    .related-products .product__item:hover .add-cart {
        opacity: 1 !important;
        visibility: visible !important;
    }

    /* 🚫 CHẶN TOÀN BỘ ANIMATION CŨ */
    .related-products .product__item:hover .product__item__text h6,
    .related-products .product__item:hover .product__item__text h5 {
        top: 0 !important;
        opacity: 1 !important;
        transform: none !important;
    }


</style>

<section class="shop-details spad">
    <div class="container">
        <div class="row">

            <!-- LEFT: IMAGE -->
            <div class="col-lg-6">
                @{
                    var allImages = Model.ProductImage
                        .OrderByDescending(x => x.IsPrimary) // main lên đầu
                        .ThenBy(x => x.SortOrder)
                        .ToList();

                    var mainImage = allImages.FirstOrDefault();
                }


                <img id="mainImage"
                     class="img-fluid mb-3"
                     src="~/assets/img/product/@mainImage.ImageUrl"
                     alt="@Model.ProductName" />


                @if (allImages.Any())
                {
                    <div class="product-detail-gallery mt-3">
                        @foreach (var img in allImages)
                        {
                            var isActive = img.ImageUrl == mainImage.ImageUrl;

                            <div class="detail-img-box @(isActive ? "active" : "")">
                                <img src="~/assets/img/product/@img.ImageUrl"
                                     alt="@Model.ProductName" />
                            </div>
                        }
                    </div>
                }



            </div>

            <!-- RIGHT: INFO -->
            <div class="col-lg-6">
                <h3 class="fw-bold">@Model.ProductName</h3>

                <h4 class="text-danger mb-3">
                    @Model.BasePrice.ToString("#,##0") đ
                </h4>
                <form method="post" action="/Cart/AddToCart">

                    <input type="hidden" name="ProductId" value="@Model.ProductId" />

                    <!-- SIZE + QUANTITY -->
                    <div class="d-flex align-items-center gap-3 mb-4">
                        <div style="min-width: 120px;">
                            <label class="fw-bold d-block mb-1">Size</label>
                            <select name="SizeId" class="form-select border-dark">
                                @foreach (var v in Model.ProductVariant.Select(x => x.Size).Distinct())
                                {
                                    <option value="@v.SizeId">@v.SizeCode</option>
                                }
                            </select>
                        </div>

                        <div style="min-width: 100px;">
                            <label class="fw-bold d-block mb-1">Số lượng</label>
                            <div class="input-group border-dark">
                                <input type="number" name="Quantity" class="form-control text-center" value="1" min="1" max="10">
                            </div>
                        </div>
                    </div>

                    <!-- MESSAGE -->
                    <div class="mb-3">
                        <label class="fw-semibold">Ghi chú</label>
                        <input type="text"
                               name="Message"
                               class="form-control"
                               placeholder="Ghi chú cho bài người bán" />
                    </div>

                    <!-- BUTTON -->
                    <button class="btn btn-dark w-100 py-2">
                        Thêm vào giỏ
                    </button>
                </form>
            </div>
        </div>

        <!-- Giới thiệu/ Đánh giá sản phẩm của khách hàng -->
        <div class="row mt-5">
            <div class="col-lg-12">
                <h5 class="fw-bold">Mô tả</h5>
                <p>@Model.Description</p>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="product__details__tab">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-toggle="tab" href="#tabs-5"
                               role="tab">Giới thiệu sản phẩm</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-toggle="tab" href="#tabs-6" role="tab">
                                Đánh giá (@(ViewBag.Reviews != null ? ViewBag.Reviews.Count : 0))

                            </a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="tabs-5" role="tabpanel">
                            <div class="product__details__tab__content">
                                <p class="note">

                                </p>
                                <div class="product__details__tab__content__item">
                                    <h5>Giới thiệu sản phẩm</h5>
                                    <p>
                                        Chiếc quần short jean này là sự lựa chọn hoàn hảo cho những chàng trai yêu thích phong cách năng động và phóng khoáng. Với thiết kế hiện đại, form dáng vừa vặn giúp tôn lên vẻ ngoài trẻ trung nhưng vẫn đảm bảo sự thoải mái tuyệt đối cho người mặc trong mọi hoạt động hàng ngày. Điểm nhấn của sản phẩm nằm ở những đường wash màu tinh tế cùng đường kim mũi chỉ chắc chắn, mang đến một vẻ đẹp bụi bặm nhưng không kém phần chỉn chu. Dù là kết hợp cùng áo thun đơn giản để dạo phố hay phối cùng sơ mi cho những buổi gặp gỡ bạn bè, chiếc quần này vẫn giúp bạn khẳng định gu thời trang cá tính và hiện đại của mình.
                                    </p>
                                    <p>
                                        Sản phẩm được chế tác từ dòng vải Denim cao cấp với sự kết hợp hoàn hảo giữa sợi Cotton tự nhiên và sợi co giãn Spandex. Chất liệu Cotton giúp bề mặt vải có độ bền cao, khả năng thấm hút mồ hôi cực tốt và cực kỳ thoáng mát, phù hợp với khí hậu nóng ẩm. Việc pha thêm sợi co giãn giúp chiếc quần có độ đàn hồi linh hoạt, không gây cảm giác gò bó khi vận động mạnh hay ngồi lâu. Đặc biệt, vải đã trải qua quy trình xử lý công nghệ cao giúp bề mặt mềm mại hơn, hạn chế tối đa tình trạng nhăn nhúm hay phai màu sau nhiều lần giặt, giữ cho sản phẩm luôn trông như mới.
                                    </p>
                                </div>
                                <div class="product__details__tab__content__item">
                                    <h5>Chất liệu sử dụng</h5>
                                    <p>
                                        Sản phẩm được chế tác từ dòng vải Denim cao cấp với sự kết hợp hoàn hảo giữa sợi Cotton tự nhiên và sợi co giãn Spandex. Chất liệu Cotton giúp bề mặt vải có độ bền cao, khả năng thấm hút mồ hôi cực tốt và cực kỳ thoáng mát, phù hợp với khí hậu nóng ẩm. Việc pha thêm sợi co giãn giúp chiếc quần có độ đàn hồi linh hoạt, không gây cảm giác gò bó khi vận động mạnh hay ngồi lâu. Đặc biệt, vải đã trải qua quy trình xử lý công nghệ cao giúp bề mặt mềm mại hơn, hạn chế tối đa tình trạng nhăn nhúm hay phai màu sau nhiều lần giặt, giữ cho sản phẩm luôn trông như mới.
                                    </p>
                                </div>
                            </div>

                           

                        </div>
                        <div class="tab-pane" id="tabs-6" role="tabpanel">
                            <div class="product__details__tab__content">
                                <div class="product__details__tab__content__item">
                                    <h4 class="fw-bold mb-4 text-uppercase"></h4>


                                    else
                                    {
                                    <div class="text-center py-5">
                                        <i class="fa fa-comments-o fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">Sản phẩm này chưa có đánh giá nào. Hãy là người đầu tiên mua và nhận xét!</p>
                                    </div>
                                    }

                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                        <h4 class="fw-bold text-uppercase mb-0">Khách hàng nhận xét</h4>

                                        @if (TempData["ReviewMessage"] != null)
                                        {
                                            <div class="alert alert-@TempData["MessageType"] alert-dismissible fade show" role="alert">
                                                <strong><i class="fa fa-info-circle"></i></strong> @TempData["ReviewMessage"]
                                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                            </div>
                                        }

                                        @if (Session["User"] != null)
                                        {
                                            @* Sửa "ProductReview" thành "ProductReviews" (phải khớp với tên File Controller của bạn) *@
                                            <a href="@Url.Action("Create", "ProductReviews", new { productId = Model.ProductId })"
                                               class="btn btn-danger btn-sm">
                                                <i class="fa fa-pencil"></i> Viết đánh giá
                                            </a>

                                        }
                                        else
                                        {
                                            <a href="@Url.Action("Login", "AppUsers", new { returnUrl = Request.RawUrl })"
                                               class="btn btn-outline-secondary btn-sm">
                                                đăng nhập Viết đánh giá
                                            </a>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-5 related-products">
                            <div class="col-lg-12">
                                <h4 class="text-center mb-4 text-uppercase fw-bold">Sản phẩm liên quan</h4>
                            </div>
                            @if (ViewBag.RelatedProducts != null)
                            {
                                foreach (var item in (List<DACK.Models.Product>)ViewBag.RelatedProducts)
                                {
                                    // 1. Xử lý lấy ảnh hiển thị
                                    var primaryImage = item.ProductImage?.FirstOrDefault(img => img.IsPrimary == true)
                                                      ?? item.ProductImage?.FirstOrDefault();
                                    var imgUrl = primaryImage != null ? primaryImage.ImageUrl : "default.jpg";

                                    <div class="col-lg-3 col-md-6 col-sm-6 mix new-arrivals">
                                        <div class="product__item">
                                            @* 2. Link đến chi tiết sản phẩm *@
                                            <a href="@Url.Action("Details", "Products", new { id = item.ProductId })">
                                                <div class="product__item__pic set-bg"
                                                     data-setbg="@Url.Content("~/assets/img/product/" + imgUrl)"
                                                     style="background-image: url('@Url.Content("~/assets/img/product/" + imgUrl)')">
                                                </div>
                                            </a>

                                            <div class="product__item__text">
                                                @* 3. HIỂN THỊ TÊN SẢN PHẨM Ở ĐÂY *@
                                                <h6><a href="@Url.Action("Details", "Products", new { id = item.ProductId })" class="text-dark">@item.ProductName</a></h6>

                                                <a href="/Cart/AddToCart/@item.ProductId" class="add-cart">+ Add To Cart</a>


                                                @* 4. Hiển thị giá *@
                                                <h5>@item.BasePrice.ToString("#,##0") đ</h5>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>

                    </div>
                </div>
            </div>
        </div>

    


    </div>
</section>


<script>
    document.querySelectorAll('.detail-img-box img').forEach(img => {
        img.addEventListener('click', function () {
            const mainImg = document.getElementById('mainImage');
            mainImg.src = this.src;

            document.querySelectorAll('.detail-img-box')
                .forEach(box => box.classList.remove('active'));

            this.parentElement.classList.add('active');
        });
    });
</script>

@*<h2>Details</h2>

    <div>
        <h4>Product</h4>
        <hr />
        <dl class="dl-horizontal">
            <dt>
                @Html.DisplayNameFor(model => model.SKU)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.SKU)
            </dd>

            <dt>
                @Html.DisplayNameFor(model => model.ProductName)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.ProductName)
            </dd>

            <dt>
                @Html.DisplayNameFor(model => model.Slug)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.Slug)
            </dd>

            <dt>
                @Html.DisplayNameFor(model => model.Description)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.Description)
            </dd>

            <dt>
                @Html.DisplayNameFor(model => model.BasePrice)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.BasePrice)
            </dd>

            <dt>
                @Html.DisplayNameFor(model => model.IsActive)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.IsActive)
            </dd>

            <dt>
                @Html.DisplayNameFor(model => model.CreatedAt)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.CreatedAt)
            </dd>

        </dl>
    </div>
    <p>
        @Html.ActionLink("Edit", "Edit", new { id = Model.ProductId }) |
        @Html.ActionLink("Back to List", "Index")
    </p>*@
